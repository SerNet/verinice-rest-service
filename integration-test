#!/bin/sh

BASEDIR=$(dirname "$0")

VERINICEDBSERVER=${VERINICEDBSERVER:-127.0.0.1:5432}
VERINICEDB=${VERINICEDB:-verinicedb_test}
VERINICEUSER=${VERINICEUSER:-verinice}
VERINICEPASSWORD=${VERINICEPASSWORD:-verinice}
VERINICEDUMP=${VERINICEDUMP:-$BASEDIR/verinice-rest/src/test/resources/test-dump.sql}
SPRINGDELAY=${SPRINGDELAY:-15}

# refresh the verinice database
if ! (psql -qd postgres -c "DROP DATABASE IF EXISTS $VERINICEDB" \
	&& createdb -O $VERINICEUSER $VERINICEDB \
	&& psql -q -U $VERINICEUSER -d $VERINICEDB -f $VERINICEDUMP > /dev/null)
then
	echo "Unable to clean up database $VERINICEDB."
	exit 1
fi

OPTS="$OPTS -Dspring.datasource.url=jdbc:postgresql://$VERINICEDBSERVER/$VERINICEDB"
OPTS="$OPTS -Dspring.datasource.username=$VERINICEUSER"
OPTS="$OPTS -Dspring.datasource.password=$VERINICEPASSWORD"

mvn -pl verinice-rest spring-boot:run $OPTS &
spring_pid=$!

sleep $SPRINGDELAY

CURDIR=$PWD
cd $BASEDIR/verinice-rest/src/test/python
python3 api_test.py
cd $CURDIR

## clean up
kill $spring_pid
